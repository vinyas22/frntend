<div class="report-root">
  <!-- Header -->
  <div class="report-header">
    <h1 class="report-title">Weekly Report</h1>
    <p class="report-desc">
      Track your weekly expenses, savings vs last week, and week-over-week improvement
    </p>
  </div>

  <!-- Period Selector -->
  <div class="report-card report-period-selector">
    <app-period-selector
      [periods]="availableWeeks"
      [selectedPeriod]="selectedWeek"
      [loading]="loading"
      periodType="week"
      (periodSelected)="onWeekSelected($event)"
      (refresh)="onRefresh()"></app-period-selector>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="report-loading">
    <div class="report-spinner"></div>
  </div>

  <!-- Error Card -->
  <div *ngIf="error && !loading" class="report-card report-error">
    <div class="report-error-content">
      <span class="report-error-icon">&#9888;</span>
      <div>
        <h4>Error Loading Report</h4>
        <p>{{ error }}</p>
        <button (click)="onRefresh()">Try again</button>
      </div>
    </div>
  </div>

  <!-- Filter Bar -->
  <div *ngIf="isFiltered()" class="report-filter-bar">
    <span>Filtering by: <b class="filter-value">{{ selectedCategory }}</b></span>
    <button (click)="clearCategoryFilter()">Clear Filter</button>
  </div>

  <!-- Main Data -->
  <div *ngIf="reportData && !loading">
    <!-- Summary Cards -->
    <div class="report-cards-row">
      <div class="report-card">
        <app-summary-card
          title="Weekly Expenses"
[value]="!selectedCategory ? (reportData?.totalExpense ?? 0) : (filteredExpense ?? 0)"
      [comparison]="expenseComparison"
          type="expense"></app-summary-card>
      </div>
    </div>

    <!-- Charts Row: Pie & Bar side by side -->
    <div class="report-charts-row">
      <div class="report-card chart-card half-chart">
        <div class="chart-title">Category Breakdown</div>
        <div #pieChart id="pieChart" class="chart-container"></div>
      </div>
      <div class="report-card chart-card half-chart">
        <div class="chart-title">Daily Expenses Bar Chart</div>
        <div #barChart id="barChart" class="chart-container"></div>
      </div>
    </div>

    <!-- âœ… REMOVED Comparison Chart Section Completely -->

    <!-- Enhanced Daily Breakdown Table -->
    <div class="report-card report-table-card">
      <div class="report-table-title">
        {{ selectedCategory ? selectedCategory + ' - Daily Breakdown' : 'Category Summary' }}
      </div>
      
      <!-- Category Summary Table (when no category selected) -->
      <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-md dark:border-gray-700">
  <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
    <thead class="bg-gray-50 dark:bg-gray-800 sticky top-0 z-10">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">Category</th>
        <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">Current Week</th>
        <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">Previous Week</th>
        <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">Change</th>
      </tr>
    </thead>
    <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
      <tr *ngFor="let category of filteredCategories"
          (click)="onCategoryClick(category.category)"
          [class.row-selected]="selectedCategory === category.category"
          class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700">
        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-gray-100">{{ category.category }}</td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-gray-900 dark:text-gray-100">{{ category.amount | currency:'INR':'symbol':'1.0-0' }}</td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-gray-900 dark:text-gray-100">
          <ng-container *ngIf="reportData?.previousWeek?.category as prev">
            {{ findCategoryAmount(getFilteredPrevCategories(prev), category.category) | currency:'INR':'symbol':'1.0-0' }}
          </ng-container>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-gray-900 dark:text-gray-100">
          <ng-container *ngIf="reportData?.previousWeek?.category as prev">
            <span [class.text-green-600]="getCategoryChange(category, getFilteredPrevCategories(prev)) < 0"
                  [class.text-red-600]="getCategoryChange(category, getFilteredPrevCategories(prev)) > 0"
                  [class.text-gray-600]="getCategoryChange(category, getFilteredPrevCategories(prev)) === 0">
              {{ getCategoryChange(category, getFilteredPrevCategories(prev)) | percentage }}
            </span>
          </ng-container>
        </td>
      </tr>
    </tbody>
  </table>
</div>


      <!-- Daily Breakdown Table (when category is selected) -->
      <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-md dark:border-gray-700 mt-6">
  <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
    <thead class="bg-gray-50 dark:bg-gray-800 sticky top-0 z-10">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">Date</th>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">Day</th>
        <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">Current Week ({{ selectedCategory }})</th>
        <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">Previous Week ({{ selectedCategory }})</th>
        <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">Difference</th>
      </tr>
    </thead>
    <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
      <tr *ngFor="let dayData of getDailyBreakdownData()"
          [class.has-current]="dayData.currentAmount > 0"
          [class.has-previous]="dayData.previousAmount > 0"
          class="hover:bg-gray-100 dark:hover:bg-gray-700">
        <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-gray-100">{{ dayData.date | date:'shortDate' }}</td>
        <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-gray-100">{{ dayData.dayName }}</td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-gray-900 dark:text-gray-100" [class.text-gray-400]="dayData.currentAmount === 0">
          {{ dayData.currentAmount | currency:'INR':'symbol':'1.0-0' }}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-gray-900 dark:text-gray-100" [class.text-gray-400]="dayData.previousAmount === 0">
          {{ dayData.previousAmount | currency:'INR':'symbol':'1.0-0' }}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-right">
          <span [class.text-green-600]="dayData.difference > 0"
                [class.text-red-600]="dayData.difference < 0"
                [class.text-gray-600]="dayData.difference === 0">
            {{ dayData.difference | currency:'INR':'symbol':'1.0-0' }}
          </span>
        </td>
      </tr>
      <tr class="bg-gray-50 dark:bg-gray-700 font-semibold">
        <td colspan="2" class="px-6 py-4">Total</td>
        <td class="px-6 py-4 text-right">{{ getDailyBreakdownTotals().currentTotal | currency:'INR':'symbol':'1.0-0' }}</td>
        <td class="px-6 py-4 text-right">{{ getDailyBreakdownTotals().previousTotal | currency:'INR':'symbol':'1.0-0' }}</td>
        <td class="px-6 py-4 text-right"
            [class.text-green-600]="getDailyBreakdownTotals().totalDifference > 0"
            [class.text-red-600]="getDailyBreakdownTotals().totalDifference < 0"
            [class.text-gray-600]="getDailyBreakdownTotals().totalDifference === 0">
          {{ getDailyBreakdownTotals().totalDifference | currency:'INR':'symbol':'1.0-0' }}
        </td>
      </tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!reportData && !loading && !error" class="report-card report-empty">
    <div class="empty-icon">&#128202;</div>
    <h4>No data available</h4>
    <p>Select a week to view your report data.</p>
  </div>
</div>

<div class="yearly-report-container">
  <!-- Header Section -->
  <div class="report-header">
    <div class="header-content">
      <h1 class="report-title">Quarterly Financial Report</h1>
      <div class="year-selector">
        <label for="quarter-select">Select Quarter:</label>
        <select 
          id="quarter-select"
          [(ngModel)]="selectedQuarter" 
          (change)="onQuarterChange()"
          [disabled]="isLoading || isLoadingQuarters"
          class="year-dropdown">
          <option value="" disabled>Choose a quarter...</option>
          <option *ngFor="let quarter of quarterOptions" [value]="quarter.value">
            {{ quarter.label }}
          </option>
        </select>
        <div class="loading-spinner" *ngIf="isLoadingQuarters">
          <span>Loading quarters...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div class="error-message" *ngIf="errorMessage">
    <div class="error-content">
      <i class="error-icon">⚠️</i>
      <span>{{ errorMessage }}</span>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <span>Loading quarterly report...</span>
    </div>
  </div>

  <!-- Report Content -->
  <div class="report-content" *ngIf="!isLoading && !errorMessage && displayReportData">
    
    <!-- Quarter Overview (Same as Year Overview) -->
    <div class="year-overview">
      <div class="overview-card">
        <h2>{{ getQuarterRange() }}</h2>
        <div class="overview-stats">
          <div class="stat-item income">
            <span class="stat-label">Total Income</span>
            <span class="stat-value">{{ formatAsINR(fullReportData?.totalIncome || 0) }}</span>
          </div>
          <div class="stat-item expense">
            <span class="stat-label">Total Expenses</span>
            <span class="stat-value">{{ formatAsINR(displayReportData.totalExpense || 0) }}</span>
          </div>
          <div class="stat-item savings">
            <span class="stat-label">Total Savings</span>
            <span class="stat-value" [class.positive]="getQuarterSavings() > 0" [class.negative]="getQuarterSavings() < 0">
              {{ formatAsINR(getQuarterSavings()) }}
            </span>
          </div>
          <div class="stat-item savings-rate">
            <span class="stat-label">Savings Rate</span>
            <span class="stat-value" [class.positive]="getQuarterSavingsRate() > 0" [class.negative]="getQuarterSavingsRate() < 0">
              {{ getQuarterSavingsRate() }}%
            </span>
          </div>
        </div>
        
        <!-- Previous Quarter Comparison -->
        <div class="comparison-stats" *ngIf="fullReportData?.previousQuarter">
          <h3>Quarter-over-Quarter Comparison</h3>
          <div class="comparison-grid">
            <div class="comparison-item">
              <span class="label">Income Change</span>
              <span class="value" 
                    [class.positive]="getIncomeChange() > 0"
                    [class.negative]="getIncomeChange() < 0">
                {{ getIncomeChange() > 0 ? '+' : '' }}{{ formatAsINR(getIncomeChange()) }}
              </span>
            </div>
            <div class="comparison-item">
              <span class="label">Expense Change</span>
              <span class="value" 
                    [class.positive]="getCurrentQuarterChange() < 0"
                    [class.negative]="getCurrentQuarterChange() > 0">
                {{ getCurrentQuarterChange() > 0 ? '+' : '' }}{{ formatAsINR(getCurrentQuarterChange()) }}
              </span>
            </div>
            <div class="comparison-item">
              <span class="label">Savings Change</span>
              <span class="value" 
                    [class.positive]="getSavingsChange() > 0"
                    [class.negative]="getSavingsChange() < 0">
                {{ getSavingsChange() > 0 ? '+' : '' }}{{ formatAsINR(getSavingsChange()) }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
      
      <!-- Category Breakdown Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>Quarterly Expense Categories</h3>
          <button class="clear-filter-btn" *ngIf="selectedCategoryFilter" (click)="clearFilter()">
            Clear Filter
          </button>
        </div>
        <div class="chart-wrapper">
          <div echarts 
               [options]="pieChartOptions" 
               (chartClick)="onChartClick($event)"
               class="pie-chart">
          </div>
        </div>
      </div>

      <!-- Monthly Trend Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>
            Monthly Expenses Trend
            <span *ngIf="selectedCategoryFilter" class="filter-indicator">
              ({{ selectedCategoryFilter }})
            </span>
          </h3>
        </div>
        <div class="chart-wrapper">
          <div echarts 
               [options]="monthlyTrendOptions" 
               class="monthly-trend-chart">
          </div>
        </div>
      </div>

      <!-- Daily Breakdown Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>
            Daily Breakdown
            <span *ngIf="selectedCategoryFilter" class="filter-indicator">
              ({{ selectedCategoryFilter }})
            </span>
          </h3>
        </div>
        <div class="chart-wrapper">
          <div echarts 
               [options]="dailyChartOptions" 
               class="daily-chart">
          </div>
        </div>
      </div>

      <!-- Quarter-over-Quarter Comparison -->
      <div class="chart-container" *ngIf="fullReportData?.previousQuarter">
        <div class="chart-header">
          <h3>
            Quarter-over-Quarter Comparison
            <span *ngIf="selectedCategoryFilter" class="filter-indicator">
              ({{ selectedCategoryFilter }})
            </span>
          </h3>
        </div>
        <div class="chart-wrapper">
          <div echarts 
               [options]="quarterComparisonOptions" 
               class="quarter-comparison-chart">
          </div>
        </div>
      </div>
    </div>

    <!-- Category Details Table -->
    <div class="category-details">
      <div class="table-header">
        <h3>Category Breakdown</h3>
        <div class="filter-loading" *ngIf="isFilterLoading">
          <span>Updating...</span>
        </div>
      </div>
      
      <div class="category-table">
        <div class="table-header-row">
          <span class="col-category">Category</span>
          <span class="col-current">Current Quarter</span>
          <span class="col-previous" *ngIf="fullReportData?.previousQuarter">Previous Quarter</span>
          <span class="col-change" *ngIf="fullReportData?.previousQuarter">Change</span>
          <span class="col-percentage">% of Total</span>
        </div>
        
        <div class="table-row" 
             *ngFor="let category of fullReportData?.category" 
             [class.selected]="selectedCategoryFilter === (category.category || 'Uncategorized')"
             (click)="toggleCategoryFilter(category.category || 'Uncategorized')">
          
          <span class="col-category">
            <span class="category-name">{{ category.category || 'Uncategorized' }}</span>
          </span>
          
          <span class="col-current">
            {{ formatAsINR(category.amount || 0) }}
          </span>
          
          <span class="col-previous" *ngIf="fullReportData?.previousQuarter">
            {{ formatAsINR(getPreviousAmount(category.category || 'Uncategorized')) }}
          </span>
          
          <span class="col-change" *ngIf="fullReportData?.previousQuarter"
                [class.positive]="getChangeAmount(category.category || 'Uncategorized') < 0"
                [class.negative]="getChangeAmount(category.category || 'Uncategorized') > 0">
            {{ getChangeAmount(category.category || 'Uncategorized') > 0 ? '+' : '' }}{{ formatAsINR(getChangeAmount(category.category || 'Uncategorized')) }}
          </span>
          
          <span class="col-percentage">
            {{ getCategoryPercentage(category.amount || 0) }}%
          </span>
        </div>
      </div>
    </div>

    <!-- Monthly Breakdown Table -->
    <div class="monthly-breakdown">
      <div class="breakdown-header">
        <h3>Monthly Breakdown</h3>
      </div>
      
      <div class="monthly-table">
        <div class="monthly-table-header">
          <span class="col-month">Month</span>
          <span class="col-expenses">Expenses</span>
          <span class="col-previous" *ngIf="fullReportData?.previousQuarter">Previous Quarter</span>
          <span class="col-change" *ngIf="fullReportData?.previousQuarter">Change</span>
        </div>
        
        <div class="monthly-table-row" *ngFor="let monthData of getMonthlyBreakdownData()">
          <span class="col-month">{{ monthData.monthName }}</span>
          <span class="col-expenses">{{ formatAsINR(monthData.currentAmount) }}</span>
          <span class="col-previous" *ngIf="fullReportData?.previousQuarter">
            {{ formatAsINR(monthData.previousAmount) }}
          </span>
          <span class="col-change" *ngIf="fullReportData?.previousQuarter"
                [class.positive]="monthData.difference < 0"
                [class.negative]="monthData.difference > 0">
            {{ monthData.difference > 0 ? '+' : '' }}{{ formatAsINR(monthData.difference) }}
          </span>
        </div>
      </div>
    </div>

    <!-- Detailed Category Breakdown -->
    <div class="detailed-breakdown" *ngIf="selectedCategoryFilter">
      <div class="breakdown-header">
        <h3>{{ selectedCategoryFilter }} - Monthly Details</h3>
        <button class="close-breakdown" (click)="clearFilter()">✕</button>
      </div>
      
      <div class="detailed-summary">
        <div class="summary-stats">
          <div class="summary-item">
            <span class="label">Current Quarter Total:</span>
            <span class="value">{{ formatAsINR(getCategoryTotalForQuarter()) }}</span>
          </div>
          <div class="summary-item" *ngIf="fullReportData?.previousQuarter">
            <span class="label">Previous Quarter Total:</span>
            <span class="value">{{ formatAsINR(getPreviousAmount(selectedCategoryFilter)) }}</span>
          </div>
          <div class="summary-item change-summary" *ngIf="fullReportData?.previousQuarter">
            <span class="label">Difference:</span>
            <span class="value" 
                  [class.positive]="getChangeAmount(selectedCategoryFilter) < 0"
                  [class.negative]="getChangeAmount(selectedCategoryFilter) > 0">
              {{ getChangeAmount(selectedCategoryFilter) > 0 ? '+' : '' }}{{ formatAsINR(getChangeAmount(selectedCategoryFilter)) }}
            </span>
          </div>
        </div>
      </div>

      <div class="detailed-monthly-table">
        <div class="detailed-table-header">
          <span class="col-month">Month</span>
          <span class="col-current">Current Quarter</span>
          <span class="col-previous" *ngIf="fullReportData?.previousQuarter">Previous Quarter</span>
          <span class="col-difference" *ngIf="fullReportData?.previousQuarter">Difference</span>
        </div>
        
        <div class="detailed-table-row" *ngFor="let month of getDetailedMonthlyData()">
          <span class="col-month">{{ month.monthName }}</span>
          <span class="col-current">{{ formatAsINR(month.currentAmount) }}</span>
          <span class="col-previous" *ngIf="fullReportData?.previousQuarter">
            {{ formatAsINR(month.previousAmount) }}
          </span>
          <span class="col-difference" *ngIf="fullReportData?.previousQuarter"
                [class.positive]="month.difference < 0"
                [class.negative]="month.difference > 0">
            {{ month.difference > 0 ? '+' : '' }}{{ formatAsINR(month.difference) }}
          </span>
        </div>
      </div>
    </div>

  </div>
</div>

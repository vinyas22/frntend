<div class="yearly-report-container">
  <!-- Header Section -->
  <div class="report-header">
    <div class="header-content">
      <h1 class="report-title">Yearly Financial Report</h1>
      <div class="year-selector">
        <label for="year-select">Select Year:</label>
        <select 
          id="year-select"
          [(ngModel)]="selectedYear" 
          (change)="onYearChange()"
          [disabled]="isLoading || isLoadingYears"
          class="year-dropdown">
          <option value="" disabled>Choose a year...</option>
          <option *ngFor="let year of yearOptions" [value]="year.value">
            {{ year.label }}
          </option>
        </select>
        <div class="loading-spinner" *ngIf="isLoadingYears">
          <span>Loading years...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div class="error-message" *ngIf="errorMessage">
    <div class="error-content">
      <i class="error-icon">⚠️</i>
      <span>{{ errorMessage }}</span>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <span>Loading yearly report...</span>
    </div>
  </div>

  <!-- Report Content -->
  <div class="report-content" *ngIf="!isLoading && !errorMessage && displayReportData">
    
    <!-- Year Overview -->
    <div class="year-overview">
      <div class="overview-card">
        <h2>{{ getYearRange() }}</h2>
        <div class="overview-stats">
          <div class="stat-item income">
            <span class="stat-label">Total Income</span>
            <span class="stat-value">{{ formatAsINR(fullReportData?.totalIncome || 0) }}</span>
          </div>
          <div class="stat-item expense">
            <span class="stat-label">Total Expenses</span>
<span class="stat-value">{{ formatAsINR(displayReportData?.totalExpense ?? 0) }}</span>
          </div>
          <div class="stat-item savings">
            <span class="stat-label">Total Savings</span>
            <span class="stat-value" [class.positive]="(fullReportData?.savings || 0) > 0" [class.negative]="(fullReportData?.savings || 0) < 0">
              {{ formatAsINR(fullReportData?.savings || 0) }}
            </span>
          </div>
          <div class="stat-item savings-rate">
            <span class="stat-label">Savings Rate</span>
            <span class="stat-value" [class.positive]="(fullReportData?.savingsRate || 0) > 0" [class.negative]="(fullReportData?.savingsRate || 0) < 0">
              {{ fullReportData?.savingsRate || 0 }}%
            </span>
          </div>
        </div>
        
        <!-- Previous Year Comparison -->
        <div class="comparison-stats" *ngIf="fullReportData?.previousYear">
          <h3>Year-over-Year Comparison</h3>
          <div class="comparison-grid">
            <div class="comparison-item">
              <span class="label">Income Change</span>
              <span class="value" 
                    [class.positive]="getIncomeChange() > 0"
                    [class.negative]="getIncomeChange() < 0">
                {{ getIncomeChange() > 0 ? '+' : '' }}{{ formatAsINR(getIncomeChange()) }}
              </span>
            </div>
            <div class="comparison-item">
              <span class="label">Expense Change</span>
              <span class="value" 
                    [class.positive]="getExpenseChange() < 0"
                    [class.negative]="getExpenseChange() > 0">
                {{ getExpenseChange() > 0 ? '+' : '' }}{{ formatAsINR(getExpenseChange()) }}
              </span>
            </div>
            <div class="comparison-item">
              <span class="label">Savings Change</span>
              <span class="value" 
                    [class.positive]="getSavingsChange() > 0"
                    [class.negative]="getSavingsChange() < 0">
                {{ getSavingsChange() > 0 ? '+' : '' }}{{ formatAsINR(getSavingsChange()) }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
      
      <!-- Category Breakdown Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>Annual Expense Categories</h3>
          <button class="clear-filter-btn" *ngIf="selectedCategoryFilter" (click)="clearFilter()">
            Clear Filter
          </button>
        </div>
        <div class="chart-wrapper">
          <div echarts 
               [options]="pieChartOptions" 
               (chartClick)="onChartClick($event)"
               class="pie-chart">
          </div>
        </div>
      </div>

      <!-- Monthly Trend Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>
            Monthly Expenses Trend
            <span *ngIf="selectedCategoryFilter" class="filter-indicator">
              ({{ selectedCategoryFilter }})
            </span>
          </h3>
        </div>
        <div class="chart-wrapper">
          <div echarts 
               [options]="monthlyTrendOptions" 
               class="monthly-trend-chart">
          </div>
        </div>
      </div>

      <!-- Quarterly Comparison Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>
            Quarterly Breakdown
            <span *ngIf="selectedCategoryFilter" class="filter-indicator">
              ({{ selectedCategoryFilter }})
            </span>
          </h3>
        </div>
        <div class="chart-wrapper">
          <div echarts 
               [options]="quarterlyChartOptions" 
               class="quarterly-chart">
          </div>
        </div>
      </div>

      <!-- Year-over-Year Comparison -->
      <div class="chart-container" *ngIf="fullReportData?.previousYear">
        <div class="chart-header">
          <h3>
            Year-over-Year Comparison
            <span *ngIf="selectedCategoryFilter" class="filter-indicator">
              ({{ selectedCategoryFilter }})
            </span>
          </h3>
        </div>
        <div class="chart-wrapper">
          <div echarts 
               [options]="yearComparisonOptions" 
               class="year-comparison-chart">
          </div>
        </div>
      </div>
    </div>

    <!-- Category Details Table -->
    <div class="category-details">
      <div class="table-header">
        <h3>Category Breakdown</h3>
        <div class="filter-loading" *ngIf="isFilterLoading">
          <span>Updating...</span>
        </div>
      </div>
      
      <div class="category-table">
        <div class="table-header-row">
          <span class="col-category">Category</span>
          <span class="col-current">Current Year</span>
          <span class="col-previous" *ngIf="fullReportData?.previousYear">Previous Year</span>
          <span class="col-change" *ngIf="fullReportData?.previousYear">Change</span>
          <span class="col-percentage">% of Total</span>
        </div>
        
        <div class="table-row" 
             *ngFor="let category of fullReportData?.category" 
             [class.selected]="selectedCategoryFilter === (category.category || 'Uncategorized')"
             (click)="toggleCategoryFilter(category.category || 'Uncategorized')">
          
          <span class="col-category">
            <span class="category-name">{{ category.category || 'Uncategorized' }}</span>
          </span>
          
          <span class="col-current">
            {{ formatAsINR(category.amount || 0) }}
          </span>
          
          <span class="col-previous" *ngIf="fullReportData?.previousYear">
            {{ formatAsINR(getPreviousAmount(category.category || 'Uncategorized')) }}
          </span>
          
          <span class="col-change" *ngIf="fullReportData?.previousYear"
                [class.positive]="getCategoryChangeAmount(category.category || 'Uncategorized') < 0"
                [class.negative]="getCategoryChangeAmount(category.category || 'Uncategorized') > 0">
            {{ getCategoryChangeAmount(category.category || 'Uncategorized') > 0 ? '+' : '' }}{{ formatAsINR(getCategoryChangeAmount(category.category || 'Uncategorized')) }}
          </span>
          
          <span class="col-percentage">
            {{ getCategoryPercentage(category.amount || 0) }}%
          </span>
        </div>
      </div>
    </div>

    <!-- Monthly Breakdown Table -->
    <div class="monthly-breakdown">
      <div class="breakdown-header">
        <h3>Monthly Breakdown</h3>
      </div>
      
      <div class="monthly-table">
        <div class="monthly-table-header">
          <span class="col-month">Month</span>
          <span class="col-expenses">Expenses</span>
          <span class="col-previous" *ngIf="fullReportData?.previousYear">Previous Year</span>
          <span class="col-change" *ngIf="fullReportData?.previousYear">Change</span>
        </div>
        
        <div class="monthly-table-row" *ngFor="let monthData of getMonthlyBreakdownData()">
          <span class="col-month">{{ monthData.monthName }}</span>
          <span class="col-expenses">{{ formatAsINR(monthData.currentAmount) }}</span>
          <span class="col-previous" *ngIf="fullReportData?.previousYear">
            {{ formatAsINR(monthData.previousAmount) }}
          </span>
          <span class="col-change" *ngIf="fullReportData?.previousYear"
                [class.positive]="monthData.difference < 0"
                [class.negative]="monthData.difference > 0">
            {{ monthData.difference > 0 ? '+' : '' }}{{ formatAsINR(monthData.difference) }}
          </span>
        </div>
      </div>
    </div>

    <!-- Detailed Category Breakdown (when category is selected) -->
    <div class="detailed-breakdown" *ngIf="selectedCategoryFilter">
      <div class="breakdown-header">
        <h3>{{ selectedCategoryFilter }} - Monthly Details</h3>
        <button class="close-breakdown" (click)="clearFilter()">✕</button>
      </div>
      
      <div class="detailed-summary">
        <div class="summary-stats">
          <div class="summary-item">
            <span class="label">Current Year Total:</span>
            <span class="value">{{ formatAsINR(getCategoryTotalForYear()) }}</span>
          </div>
          <div class="summary-item" *ngIf="fullReportData?.previousYear">
            <span class="label">Previous Year Total:</span>
            <span class="value">{{ formatAsINR(getPreviousAmount(selectedCategoryFilter)) }}</span>
          </div>
          <div class="summary-item change-summary" *ngIf="fullReportData?.previousYear">
            <span class="label">Difference:</span>
            <span class="value" 
                  [class.positive]="getCategoryChangeAmount(selectedCategoryFilter) < 0"
                  [class.negative]="getCategoryChangeAmount(selectedCategoryFilter) > 0">
              {{ getCategoryChangeAmount(selectedCategoryFilter) > 0 ? '+' : '' }}{{ formatAsINR(getCategoryChangeAmount(selectedCategoryFilter)) }}
            </span>
          </div>
        </div>
      </div>

      <div class="detailed-monthly-table">
        <div class="detailed-table-header">
          <span class="col-month">Month</span>
          <span class="col-current">Current Year</span>
          <span class="col-previous" *ngIf="fullReportData?.previousYear">Previous Year</span>
          <span class="col-difference" *ngIf="fullReportData?.previousYear">Difference</span>
        </div>
        
        <div class="detailed-table-row" *ngFor="let month of getDetailedMonthlyData()">
          <span class="col-month">{{ month.monthName }}</span>
          <span class="col-current">{{ formatAsINR(month.currentAmount) }}</span>
          <span class="col-previous" *ngIf="fullReportData?.previousYear">
            {{ formatAsINR(month.previousAmount) }}
          </span>
          <span class="col-difference" *ngIf="fullReportData?.previousYear"
                [class.positive]="month.difference < 0"
                [class.negative]="month.difference > 0">
            {{ month.difference > 0 ? '+' : '' }}{{ formatAsINR(month.difference) }}
          </span>
        </div>
      </div>
    </div>

  </div>
</div>
